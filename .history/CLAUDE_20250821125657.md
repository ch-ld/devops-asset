# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a DevOps Asset Management System - a modern cloud-native enterprise-level asset management platform built with Vue 3 + Go architecture.

**Key Features:**
- Cloud account management (Multi-cloud support: Alibaba Cloud, Tencent Cloud, AWS)
- Host management with monitoring and alerts
- DNS & certificate management with Let's Encrypt integration
- CMDB (Configuration Management Database)
- User and role management with RBAC
- Real-time monitoring and alerting
- SSH/SFTP terminal access

## Technology Stack

### Backend (Go)
- **Framework**: Gin + GORM + MySQL + Redis
- **Language**: Go 1.24.1
- **Authentication**: JWT
- **Database**: MySQL 8.0, Redis 7.0
- **Documentation**: Swagger/OpenAPI
- **Logging**: Zap structured logging
- **Architecture**: Domain-driven design with layered architecture

### Frontend (Vue)
- **Framework**: Vue 3 + TypeScript + Vite
- **UI Library**: Element Plus (primary), some Ant Design Vue components
- **State Management**: Pinia
- **Router**: Vue Router with dynamic routes
- **Build Tool**: Vite
- **Template Base**: Art-Design-Pro template

## Development Commands

### Backend Development
```bash
cd server

# Install dependencies
go mod download

# Database migration
go run cmd/main.go --migrate

# Run development server
go run cmd/main.go --dev

# Build for production
go build -o main cmd/main.go
```

### Frontend Development
```bash
cd web

# Install dependencies
pnpm install

# Run development server
pnpm dev

# Build for production
pnpm build

# Lint and fix code
pnpm lint
pnpm fix

# Run tests
pnpm test
```

### Docker Deployment
```bash
# Production deployment
docker-compose --profile production up -d

# Development deployment
docker-compose --profile development up -d

# Using deployment script
./deploy.sh production          # Production
./deploy.sh development         # Development
./deploy.sh status             # Check status
./deploy.sh health             # Health check
```

## Project Structure

### Backend Structure
```
server/
├── cmd/main.go                 # Application entry point
├── internal/
│   ├── api/handler/            # HTTP handlers (Gin controllers)
│   │   ├── cmdb/              # CMDB module handlers
│   │   ├── dns/               # DNS module handlers
│   │   └── system/            # System handlers
│   ├── service/               # Business logic layer
│   ├── repository/            # Data access layer (GORM)
│   ├── model/                 # Database models
│   ├── router/                # Route definitions
│   ├── middleware/            # HTTP middleware
│   ├── response/              # Unified response handling
│   ├── config/                # Configuration management
│   └── db/                    # Database clients
├── configs/                   # Configuration files
├── pkg/                       # Shared packages
└── docs/                      # API documentation
```

### Frontend Structure
```
web/
├── src/
│   ├── api/                   # API client definitions
│   ├── components/            # Reusable components
│   ├── views/                 # Page components
│   │   ├── cmdb/             # CMDB module pages
│   │   ├── dns/              # DNS module pages
│   │   └── system/           # System pages
│   ├── router/               # Router configuration
│   ├── store/                # Pinia state management
│   ├── utils/                # Utility functions
│   └── assets/               # Static assets
├── public/                   # Public assets
└── docs/                     # Frontend documentation
```

## Architectural Principles

### Backend Design Patterns
- **Layered Architecture**: Handler → Service → Repository → Model
- **Unified Response**: All HTTP endpoints return 200 with standardized JSON structure
- **Error Handling**: Service layer returns `ServiceError`, handled by middleware
- **Authentication**: JWT middleware with development mode bypass
- **Multi-tenancy**: Tenant isolation at database level

### Response Format
```go
{
    "code": 200,           // Business status code
    "status": "success",   // Status text
    "message": "OK",       // Optional message
    "data": {},           // Response data
    "count": 0,           // Optional count for pagination
    "timestamp": 1640995200 // Unix timestamp
}
```

### Service Layer Pattern
```go
// Business errors use ServiceError
func (s *SomeService) DoSomething() error {
    if err := validation; err != nil {
        return response.NewServiceError(response.INVALID_PARAMS, "validation failed")
    }
    return nil
}

// Handler converts ServiceError to HTTP response
func (h *SomeHandler) HandleRequest(c *gin.Context) {
    if err := h.service.DoSomething(); err != nil {
        middleware.HandleServiceError(c, err)
        return
    }
    response.ReturnSuccess(c)
}
```

### Frontend Conventions
- **API Client**: Centralized in `src/api/client.ts`
- **Error Handling**: Unified response interceptor handles all API errors
- **Component Library**: Primarily Element Plus (`el-*`), minimal Ant Design Vue
- **Route Guards**: Authentication and permission checks in `router/guards/`
- **State Management**: Modular Pinia stores by feature

## Key Modules

### 1. DNS & Certificate Management
- **Location**: `server/internal/*/dns/`, `web/src/views/dns/`
- **Features**: Domain management, DNS records, Let's Encrypt certificates, HTTPS monitoring
- **Providers**: Alibaba Cloud, AWS Route53, Tencent Cloud, GoDaddy
- **Key Files**:
  - Backend: `internal/service/dns/`, `internal/provider/dns/`
  - Frontend: `views/dns/domains/`, `views/dns/certs/`

### 2. CMDB Host Management
- **Location**: `server/internal/*/cmdb/`, `web/src/views/cmdb/`
- **Features**: Host inventory, monitoring, SSH terminals, file transfer
- **Key Components**: Host groups, cloud adapters, metrics collection
- **Key Files**:
  - Backend: `internal/service/cmdb/`, `internal/adapter/`
  - Frontend: `views/cmdb/host/`, `components/ssh/`

### 3. User & System Management
- **Location**: `server/internal/*/system/`, `web/src/views/system/`
- **Features**: User management, roles, permissions, menu system
- **Authentication**: JWT with RBAC
- **Key Files**:
  - Backend: `internal/service/user_service.go`
  - Frontend: `views/system/user/`, `store/modules/user.ts`

## Development Guidelines

### Code Standards
- **Go**: Follow official Go conventions, use `gofmt` and `golangci-lint`
- **Vue**: Use Composition API, TypeScript strict mode
- **Naming**: Use clear, descriptive names; avoid abbreviations
- **Comments**: Document business logic and complex algorithms

### API Development
1. Define model in `internal/model/`
2. Create repository in `internal/repository/`
3. Implement service in `internal/service/`
4. Add handler in `internal/api/handler/`
5. Register routes in `internal/router/`
6. Add frontend API client in `src/api/`

### Database Conventions
- **Migrations**: Place in `server/internal/database/migrations/`
- **Models**: Use GORM conventions, soft deletes with `deleted_at`
- **Relationships**: Prefer explicit foreign keys
- **Indexing**: Add indexes for frequently queried columns

### Security Best Practices
- Never log secrets, tokens, or passwords
- Use AES encryption for sensitive data storage
- Validate all input parameters
- Use prepared statements (GORM handles this)
- Implement proper RBAC checks

## Testing

### Backend Testing
```bash
cd server
go test ./...                  # Run all tests
go test -cover ./...           # With coverage
go test -v ./internal/service/ # Specific package
```

### Frontend Testing
```bash
cd web
pnpm test                      # Run tests
pnpm test:coverage            # With coverage
```

## Configuration

### Environment Variables
- `APP_MODE`: `dev` or `prod`
- `MYSQL_*`: Database configuration
- `REDIS_*`: Redis configuration
- `JWT_SECRET`: JWT signing key
- `AES_KEY`: Encryption key (32 characters)

### Configuration Files
- Backend: `server/configs/config.yaml` (environment-specific)
- Frontend: `web/.env.development`, `web/.env.production`

## Common Development Tasks

### Add New Feature Module
1. Create database models and migrations
2. Implement repository layer with CRUD operations
3. Add service layer with business logic
4. Create HTTP handlers with Swagger docs
5. Register routes with appropriate middleware
6. Build frontend pages and components
7. Add API client methods
8. Update navigation menus

### Debug Issues
- Backend logs: `server/log/` directory
- Frontend: Browser developer tools
- API testing: Use Swagger UI at `/swagger/index.html`
- Health check: GET `/health`

## Important Notes

- **UI Framework**: Project uses Element Plus as primary UI library. Avoid mixing with other UI frameworks.
- **Authentication**: Development mode (`--dev` flag) bypasses JWT for easier testing
- **Multi-tenant**: All data operations should include tenant filtering
- **Error Codes**: Use predefined codes in `response/code.go`
- **Documentation**: Keep this CLAUDE.md updated with architectural changes

## Useful Scripts and Commands

### Database Operations
```bash
# Run migrations
go run cmd/main.go --migrate

# Reset database (development only)
go run cmd/main.go --migrate --reset
```

### Development Workflow
```bash
# Start backend (development mode)
cd server && go run cmd/main.go --dev

# Start frontend
cd web && pnpm dev

# Full stack with Docker
./deploy.sh development
```

### Production Deployment
```bash
# Build and deploy
./deploy.sh production

# Health check
./deploy.sh health

# View logs
docker-compose logs -f
```

This codebase follows modern DevOps practices with containerized deployment, comprehensive monitoring, and security-first design principles.