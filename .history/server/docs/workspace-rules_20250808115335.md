# 工作区规则（Backend / Frontend）

> 本文档统一约定 devops-asset 的后端与前端开发规范、接口契约与目录结构，供团队协作与代码评审使用。

## 技术栈
- 后端：Go 1.24.1、Gin、GORM、Zap、Swaggo、MySQL、Redis
- 前端：Vue 3、TypeScript、Vite、Element Plus
- 前端模板来源：基于 Art-Design-Pro 二次开发（不是组件库，而是后台管理系统模板）。参考仓库：[Art-Design-Pro](https://github.com/Daymychen/art-design-pro)

## 项目结构（关键目录）
- 后端
  - `server/internal/api/handler/...` 接口层（HTTP 入参绑定、鉴权、调用服务、统一响应）
  - `server/internal/service/...` 业务层（事务与领域逻辑，返回业务错误）
  - `server/internal/repository/...` 数据访问（GORM 操作、查询聚合）
  - `server/internal/model/...` 数据模型
  - `server/internal/router/...` 路由注册
  - `server/internal/middleware/...` 中间件（JWT、CORS、错误恢复等）
  - `server/internal/response/response/` 统一响应封装与错误码
  - `server/internal/db/mysql/`, `server/internal/db/redis/` 数据源客户端
  - `server/internal/config/` 配置（文件在 `server/configs/`）
- 前端（基于 Art-Design-Pro，结合当前仓库 `web/` 实际结构）
  - `web/src/api/*` 接口定义与请求客户端（`client.ts`）
  - `web/src/router/*` 路由与守卫（`guards/`）
  - `web/src/store/*` 应用状态（模块化）
  - `web/src/views/*` 页面视图
  - `web/src/components/*` 组件
  - `web/src/utils/*` 工具与拦截器
  - `web/src/assets/*` 样式与资源

## 后端规则
- 路由
  - 入口：`router.InitRouter()`；基础路径前缀：`/api/v1`
  - 公共路由：`/`、`/health`、`/swagger-login`、`/swagger/*any`（swagger 需鉴权）
  - 全局中间件：日志、错误恢复、跨域；静态：`/uploads -> ./uploads`；`/docs -> ./docs`
- 鉴权
  - 保护路由统一使用 `middleware.JWTAuth()`
  - Token 提取顺序：`Authorization: Bearer <token>` → `Access-Token` → 头 `constants.JWTHeaderKey` → 查询 `token`
  - 开发模式 `config.IsDev()` 自动放行并注入 `user_id=1`, `tenant_id=1`
- 统一响应
  - HTTP 固定返回 200；语义状态放在响应体字段
  - 结构：`{ code:number, status:string, message?:string, data?:any, count?:number, timestamp:number }`
  - 使用：`ReturnData(c, data)`、`ReturnDataWithCount(c, count, data)`、`ReturnSuccess(c)`、`ReturnError(c, code, msg)`、`ReturnErrorWithData(c, code, data)`
  - Service 层业务失败：返回 `response.NewServiceError(code, msg)`；Handler 层用 `middleware.HandleServiceError(c, err)` 统一翻译
  - 数据整形：时间转 Unix 秒；`gorm.Model` 输出 `{ id, created_at, updated_at, deleted_at? }`
- 错误码
  - 使用 `server/internal/response/response/code.go` 预置常量（通用与 DNS 业务段 67001–67158）
  - 需要扩展时在 `code.go` 新增，禁止随意造码
- Handler 模式
  - 入参绑定与校验（`validator/v10`）→ 调用 Service → 成功走 `ReturnData/WithCount`，失败走 `HandleServiceError`
  - 不直接返回敏感字段；依赖 `processData` 做时间与 ID 整形
- Service
  - 只负责业务，不引入 Gin；事务在此集中管理
  - 业务失败统一 `NewServiceError`（绑定标准错误码）
- Repository / DB
  - 连接：`mysql.GetClient()`；GORM 读写尽量传递 `context.Context`
  - `ErrRecordNotFound` 映射为 `response.NOT_FOUND`
  - 迁移：`server/internal/database/migrations/` 与 `server/internal/db/migration.go`，保持幂等
- Redis
  - 获取：`redis.GetClient()`；使用前可 `redis.IsAvailable()`；缓存失败不影响主流程（fail-open）
- 日志
  - 使用 `zap.L()`；全局配置见 `server/pkg/logger/log`
  - 生产禁止 `fmt.Printf`；记录结构化字段（ID、耗时、大小）
- 配置
  - 文件：`server/configs/*.yaml`；调用 `internal/config`
  - 开发模式行为遵循 `config.IsDev()`（JWT 放行、日志级别等）

## 前端规则（Art-Design-Pro 模板约定）
- 模板定位
  - 前端基于 [Art-Design-Pro](https://github.com/Daymychen/art-design-pro) 二次开发；它是后台管理系统模板，不是组件库
  - 统一使用 Vue 3 + TS + Vite + Element Plus 技术栈
- 目录与模块
  - API 客户端集中在 `src/api/client.ts`，各业务 API 在 `src/api/<module>/*`
  - 全局路由守卫位于 `src/router/guards/*`，用于登录态校验与动态路由注册
  - 全局状态在 `src/store/*`（按模块划分），需避免在组件中直接拼装复杂业务
  - 业务页面在 `src/views/*`，复用组件在 `src/components/*`，通用工具在 `src/utils/*`
- 接口与响应
  - 与后端契约保持一致：所有请求 HTTP 200，成功以 `body.code === 200` 判定
  - 未登录/失效（如 `UNAUTHENTICATED`）：清理令牌并跳转登录
  - 统一在 `client.ts` 拦截器中处理 `code/status/message`，组件中只关心业务数据
- 组件与样式
  - 组件使用 `<script setup lang="ts">` 与组合式 API；类型明确、props/emit 明确
  - UI 使用 Element Plus，主题风格与 Art-Design-Pro 一致；公共样式放 `src/assets/styles`
  - 避免在组件内直接写业务请求，使用 composables 或调用 `api/*`
- 代码风格与提交
  - 严格 TypeScript 类型；避免 `any`
  - ESLint + Prettier 统一风格，按 Art-Design-Pro 的配置（`eslint.config.mjs` 等）
  - 提交信息遵循 `commitlint.config.cjs`（feat/fix/docs/chore 等）

## 前后端接口契约要点
- HTTP 200 固定；错误通过响应体 `code/status/message` 表达
- 时间统一为 Unix 秒；`id` 等主键命名小写
- 分页返回使用 `ReturnDataWithCount`，前端读取 `count`
- 认证失败用 `UNAUTHENTICATED`，权限不足用 `PERMISSION_DENIED`

## 新增功能 Checklist
1. 后端
   - Model → Repository → Service（业务失败 `NewServiceError`）→ Handler（`HandleServiceError`/`ReturnData`）
   - 增加路由于 `internal/router/<module>.go`
   - 需要时在 `response/code.go` 扩展错误码，并补充 Swagger 注释
2. 前端
   - 在 `src/api/<module>` 新增接口方法
   - 视图在 `src/views/<module>`，必要时新增复用组件于 `src/components`
   - 路由在 `src/router` 注册，鉴权/重定向在 `guards` 统一处理
   - 统一用 `client.ts` 发起请求并处理返回码

## 构建与运行
- 后端
  - 开发：`cd server && go run cmd/main.go`
  - 测试：`cd server && go test ./...`
- 前端
  - 安装：`cd web && pnpm install`
  - 开发：`pnpm dev`
  - 构建：`pnpm build`

## 安全与合规
- 禁止打印/记录密钥、令牌、密码等敏感信息
- 入参严格校验；枚举/类型使用白名单
- SQL 通过 GORM 预编译实现，禁止字符串拼接 SQL

---

文档维护说明：
- 本规则文档路径：`docs/workspace-rules.md` 与 `server/docs/workspace-rules.md`
- 新增或变更模块时，请同步更新本文件相关章节（后端/前端/接口契约/Checklist） 
