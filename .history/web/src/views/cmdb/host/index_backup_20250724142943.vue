<template>
  <div class="host-management">
    <div class="page-container">
      <!-- Â∑¶‰æßËæπÊ†è -->
      <div class="sidebar">
        <div class="sidebar-header">
          <div class="header-content">
            <div class="header-title">
              <i class="icon">üìÅ</i>
              <h3>‰∏ªÊú∫ÂàÜÁªÑ</h3>
            </div>
            <el-button size="small" type="primary" @click="refreshGroups" :loading="groupLoading">
              Âà∑Êñ∞
            </el-button>
          </div>
        </div>
        
        <div class="group-search">
          <el-input
            v-model="groupSearchQuery"
            placeholder="ÊêúÁ¥¢ÂàÜÁªÑ..."
            clearable
            size="small"
          />
        </div>

        <div class="group-tree-container">
          <el-tree
            :data="filteredGroupTree"
            :props="treeProps"
            node-key="id"
            :current-node-key="selectedGroupId"
            @node-click="handleGroupSelect"
            :expand-on-click-node="false"
            class="group-tree"
          >
            <template #default="{ node, data }">
              <div
                class="tree-node"
                @contextmenu="(e) => handleGroupRightClick(e, node, data)"
              >
                <span class="node-label">{{ node.label }}</span>
                <span class="node-count">({{ data.host_count || 0 }})</span>
                <div class="node-actions" v-if="data.id !== null">
                  <el-button
                    type="text"
                    size="small"
                    @click.stop="handleAddGroup(data)"
                    title="Ê∑ªÂä†Â≠êÁªÑ"
                  >
                    +
                  </el-button>
                  <el-button
                    type="text"
                    size="small"
                    @click.stop="handleEditGroup(data)"
                    title="ÁºñËæë"
                  >
                    ‚úé
                  </el-button>
                  <el-button
                    type="text"
                    size="small"
                    @click.stop="handleDeleteGroup(data)"
                    title="Âà†Èô§"
                  >
                    ‚úï
                  </el-button>
                </div>
              </div>
            </template>
          </el-tree>
        </div>
      </el-aside>

      <!-- Âè≥‰æß‰∏ªÂÜÖÂÆπÂå∫ -->
      <el-main class="main-content">
        <!-- È°µÈù¢Ê†áÈ¢òÂíåÂ∑•ÂÖ∑Ê†è -->
        <div class="content-header">
          <div class="header-left">
            <h1 class="page-title">‰∏ªÊú∫ÁÆ°ÁêÜ</h1>
            <div class="breadcrumb">
              <span class="breadcrumb-item">‰∏ªÊú∫ÁÆ°ÁêÜ</span>
              <span class="breadcrumb-separator">/</span>
              <span class="breadcrumb-current">{{ selectedGroupName || 'ÂÖ®ÈÉ®‰∏ªÊú∫' }}</span>
            </div>
          </div>
          <div class="header-actions">
            <el-button type="primary" @click="refreshData" :loading="loading">
              Âà∑Êñ∞Êï∞ÊçÆ
            </el-button>
            <el-button type="success" @click="handleAdd">
              Ê∑ªÂä†‰∏ªÊú∫
            </el-button>
          </div>
        </div>

        <!-- ÊêúÁ¥¢Á≠õÈÄâÂ∑•ÂÖ∑Ê†è -->
        <div class="toolbar">
          <el-row :gutter="16" align="middle">
            <el-col :span="8">
              <el-input
                v-model="searchParams.keyword"
                placeholder="ÊêúÁ¥¢‰∏ªÊú∫ÂêçÁß∞„ÄÅIPÂú∞ÂùÄ..."
                clearable
                @input="handleSearch"
                class="search-input"
              />
            </el-col>
            <el-col :span="4">
              <el-select
                v-model="searchParams.status"
                placeholder="Áä∂ÊÄÅÁ≠õÈÄâ"
                clearable
                @change="handleSearch"
                class="filter-select"
              >
                <el-option label="ÂÖ®ÈÉ®Áä∂ÊÄÅ" value="" />
                <el-option label="ËøêË°å‰∏≠" value="running" />
                <el-option label="Â∑≤ÂÅúÊ≠¢" value="stopped" />
                <el-option label="Áª¥Êä§‰∏≠" value="maintenance" />
              </el-select>
            </el-col>
            <el-col :span="4">
              <el-select
                v-model="searchParams.region"
                placeholder="Âú∞ÂüüÁ≠õÈÄâ"
                clearable
                @change="handleSearch"
                class="filter-select"
              >
                <el-option label="ÂÖ®ÈÉ®Âú∞Âüü" value="" />
                <el-option label="Âçé‰∏ú1" value="cn-hangzhou" />
                <el-option label="Âçé‰∏ú2" value="cn-shanghai" />
                <el-option label="ÂçéÂåó1" value="cn-qingdao" />
                <el-option label="ÂçéÂåó2" value="cn-beijing" />
                <el-option label="ÂçéÂçó1" value="cn-shenzhen" />
                <el-option label="Êñ∞Âä†Âù°" value="ap-southeast-1" />
              </el-select>
            </el-col>
            <el-col :span="4">
              <el-select
                v-model="providerFilter"
                placeholder="‰∫ëÂéÇÂïÜÁ≠õÈÄâ"
                clearable
                @change="handleProviderFilter"
                class="filter-select"
              >
                <el-option label="ÂÖ®ÈÉ®ÂéÇÂïÜ" value="" />
                <el-option label="ÈòøÈáå‰∫ë" value="aliyun" />
                <el-option label="ËÖæËÆØ‰∫ë" value="tencent" />
                <el-option label="Âçé‰∏∫‰∫ë" value="huawei" />
                <el-option label="AWS" value="aws" />
                <el-option label="Ëá™Âª∫" value="manual" />
              </el-select>
            </el-col>
          </el-row>
        </div>

        <!-- ‰∏ªÊú∫ÂàóË°®Ë°®Ê†º -->
        <div class="table-container">
          <el-table
            :data="displayHostList"
            v-loading="loading"
            element-loading-text="Êï∞ÊçÆÂä†ËΩΩ‰∏≠..."
            stripe
            class="host-table"
            @selection-change="handleSelectionChange"
          >
            <!-- ÈÄâÊã©Âàó -->
            <el-table-column type="selection" width="55" />
            
            <!-- ‰∏ªÊú∫ÂêçÁß∞ -->
            <el-table-column prop="name" label="‰∏ªÊú∫ÂêçÁß∞" min-width="180" show-overflow-tooltip>
              <template #default="{ row }">
                <div class="host-name-cell">
                  <span class="host-name">{{ row.name }}</span>
                </div>
              </template>
            </el-table-column>

            <!-- IPÂú∞ÂùÄ -->
            <el-table-column label="IPÂú∞ÂùÄ" min-width="140">
              <template #default="{ row }">
                <div class="ip-cell">
                  <div class="ip-item" v-if="getDisplayIP(row.public_ip)">
                    <span class="ip-label">ÂÖ¨ÁΩë:</span>
                    <span class="ip-value">{{ getDisplayIP(row.public_ip) }}</span>
                  </div>
                  <div class="ip-item" v-if="getDisplayIP(row.private_ip)">
                    <span class="ip-label">ÁßÅÁΩë:</span>
                    <span class="ip-value">{{ getDisplayIP(row.private_ip) }}</span>
                  </div>
                </div>
              </template>
            </el-table-column>

            <!-- Áä∂ÊÄÅ -->
            <el-table-column prop="status" label="Áä∂ÊÄÅ" width="100" align="center">
              <template #default="{ row }">
                <el-tag :type="getStatusTagType(row.status)" size="small">
                  {{ getStatusDisplayText(row.status) }}
                </el-tag>
              </template>
            </el-table-column>

            <!-- ÈÖçÁΩÆ‰ø°ÊÅØ -->
            <el-table-column label="ÈÖçÁΩÆ" width="180" align="center">
              <template #default="{ row }">
                <div class="config-specs">
                  <div class="spec-item">
                    <span class="spec-label">CPU:</span>
                    <span class="spec-value">{{ formatConfiguration(row.configuration).cpu }}</span>
                  </div>
                  <div class="spec-item">
                    <span class="spec-label">ÂÜÖÂ≠ò:</span>
                    <span class="spec-value">{{ formatConfiguration(row.configuration).memory }}</span>
                  </div>
                  <div class="spec-item">
                    <span class="spec-label">Á£ÅÁõò:</span>
                    <span class="spec-value">{{ formatConfiguration(row.configuration).disk }}</span>
                  </div>
                </div>
              </template>
            </el-table-column>

            <!-- Êìç‰ΩúÁ≥ªÁªü -->
            <el-table-column prop="os" label="Á≥ªÁªü" width="100" show-overflow-tooltip>
              <template #default="{ row }">
                <span class="os-text">{{ row.os || '-' }}</span>
              </template>
            </el-table-column>

            <!-- Âú∞Âüü -->
            <el-table-column prop="region" label="Âú∞Âüü" width="120">
              <template #default="{ row }">
                <span class="region-text">{{ getRegionDisplay(row.region) }}</span>
              </template>
            </el-table-column>

            <!-- ‰∫ëÂéÇÂïÜ -->
            <el-table-column label="‰∫ëÂéÇÂïÜ" width="100" align="center">
              <template #default="{ row }">
                <el-tag :type="getProviderTagType(row.provider_type)" size="small">
                  {{ getProviderDisplayText(row.provider_type) }}
                </el-tag>
              </template>
            </el-table-column>

            <!-- Êìç‰ΩúÊåâÈíÆ -->
            <el-table-column label="Êìç‰Ωú" width="240" align="center" fixed="right">
              <template #default="{ row }">
                <div class="action-buttons">
                  <el-button type="primary" size="small" @click="handleView(row)">
                    Êü•Áúã
                  </el-button>
                  <el-button type="success" size="small" @click="handleTerminal(row)">
                    ÁªàÁ´Ø
                  </el-button>
                  <el-button type="warning" size="small" @click="handleEdit(row)">
                    ÁºñËæë
                  </el-button>
                  <el-button type="danger" size="small" @click="handleDelete(row)">
                    Âà†Èô§
                  </el-button>
                </div>
              </template>
            </el-table-column>
          </el-table>
        </div>

        <!-- ÂàÜÈ°µ -->
        <div class="pagination-wrapper">
          <el-pagination
            @size-change="handleSizeChange"
            @current-change="handleCurrentChange"
            :current-page="pagination.page"
            :page-sizes="[10, 20, 50, 100]"
            :page-size="pagination.pageSize"
            layout="total, sizes, prev, pager, next, jumper"
            :total="pagination.total"
            background
          />
        </div>
      </el-main>
    </el-container>

    <!-- ‰∏ªÊú∫ÁªÑÁÆ°ÁêÜÂØπËØùÊ°Ü -->
    <el-dialog
      v-model="groupDialogVisible"
      :title="isEditingGroup ? 'ÁºñËæë‰∏ªÊú∫ÁªÑ' : 'Êñ∞Âª∫‰∏ªÊú∫ÁªÑ'"
      width="500px"
    >
      <el-form :model="groupFormData" label-width="80px">
        <el-form-item label="ÁªÑÂêçÁß∞" required>
          <el-input v-model="groupFormData.name" placeholder="ËØ∑ËæìÂÖ•‰∏ªÊú∫ÁªÑÂêçÁß∞" />
        </el-form-item>
        <el-form-item label="ÊèèËø∞">
          <el-input
            v-model="groupFormData.description"
            type="textarea"
            placeholder="ËØ∑ËæìÂÖ•ÊèèËø∞‰ø°ÊÅØ"
            :rows="3"
          />
        </el-form-item>
      </el-form>
      <template #footer>
        <span class="dialog-footer">
          <el-button @click="groupDialogVisible = false">ÂèñÊ∂à</el-button>
          <el-button type="primary" @click="saveGroup">Á°ÆÂÆö</el-button>
        </span>
      </template>
    </el-dialog>

    <!-- Ê∑ªÂä†‰∏ªÊú∫ÂØπËØùÊ°Ü -->
    <el-dialog
      v-model="addHostDialogVisible"
      title="Ê∑ªÂä†‰∏ªÊú∫"
      width="600px"
      :before-close="() => addHostDialogVisible = false"
    >
      <el-form :model="hostFormData" label-width="100px" class="host-form">
        <el-row :gutter="20">
          <el-col :span="12">
            <el-form-item label="‰∏ªÊú∫ÂêçÁß∞" required>
              <el-input v-model="hostFormData.name" placeholder="ËØ∑ËæìÂÖ•‰∏ªÊú∫ÂêçÁß∞" />
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="‰∫ëÂéÇÂïÜ" required>
              <el-select v-model="hostFormData.provider_type" placeholder="ÈÄâÊã©‰∫ëÂéÇÂïÜ">
                <el-option label="AWS" value="aws" />
                <el-option label="ÈòøÈáå‰∫ë" value="aliyun" />
                <el-option label="ËÖæËÆØ‰∫ë" value="tencent" />
                <el-option label="Âçé‰∏∫‰∫ë" value="huawei" />
              </el-select>
            </el-form-item>
          </el-col>
        </el-row>

        <el-row :gutter="20">
          <el-col :span="12">
            <el-form-item label="ÂÖ¨ÁΩëIP">
              <el-input v-model="hostFormData.public_ip[0]" placeholder="ËØ∑ËæìÂÖ•ÂÖ¨ÁΩëIP" />
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="ÁßÅÁΩëIP">
              <el-input v-model="hostFormData.private_ip[0]" placeholder="ËØ∑ËæìÂÖ•ÁßÅÁΩëIP" />
            </el-form-item>
          </el-col>
        </el-row>

        <el-row :gutter="20">
          <el-col :span="12">
            <el-form-item label="Êìç‰ΩúÁ≥ªÁªü">
              <el-input v-model="hostFormData.os" placeholder="Â¶ÇÔºöUbuntu 20.04" />
            </el-form-item>
          </el-col>
          <el-col :span="12">
            <el-form-item label="Âú∞Âüü">
              <el-input v-model="hostFormData.region" placeholder="Â¶ÇÔºöus-east-1" />
            </el-form-item>
          </el-col>
        </el-row>

        <el-row :gutter="20">
          <el-col :span="8">
            <el-form-item label="CPUÊ†∏Êï∞">
              <el-input-number v-model="hostFormData.configuration.cpu_cores" :min="1" :max="64" />
            </el-form-item>
          </el-col>
          <el-col :span="8">
            <el-form-item label="ÂÜÖÂ≠ò(GB)">
              <el-input-number v-model="hostFormData.configuration.memory_size" :min="1" :max="512" />
            </el-form-item>
          </el-col>
          <el-col :span="8">
            <el-form-item label="Á£ÅÁõò(GB)">
              <el-input-number v-model="hostFormData.configuration.disk_size" :min="8" :max="2048" />
            </el-form-item>
          </el-col>
        </el-row>

        <el-form-item label="ÂÆû‰æãÁ±ªÂûã">
          <el-input v-model="hostFormData.configuration.instance_type" placeholder="Â¶ÇÔºöt2.micro" />
        </el-form-item>
      </el-form>

      <template #footer>
        <div class="dialog-footer">
          <el-button @click="addHostDialogVisible = false">ÂèñÊ∂à</el-button>
          <el-button type="primary" @click="saveHost">Á°ÆÂÆö</el-button>
        </div>
      </template>
    </el-dialog>

    <!-- SSHÁªàÁ´ØÂØπËØùÊ°Ü -->
    <el-dialog
      v-model="terminalVisible"
      :title="`SSHÁªàÁ´Ø - ${currentHost?.name}`"
      width="80%"
      :before-close="() => { terminalVisible = false; currentHost = null }"
    >
      <SSHTerminal
        v-if="terminalVisible && currentHost"
        :host="currentHost"
        @close="terminalVisible = false"
      />
    </el-dialog>
  </div>
</template>

<script setup>
import { ref, reactive, computed, onMounted, nextTick } from 'vue'
import { ElMessage, ElMessageBox, ElDialog } from 'element-plus'
import { storeToRefs } from 'pinia'
import { useHostStore } from '@/store/modules/host'
import SSHTerminal from './components/SSHTerminal.vue'

// Store
const hostStore = useHostStore()
const { hostList, pagination, isLoading } = storeToRefs(hostStore)
const hostGroupTree = ref([])

// ÂìçÂ∫îÂºèÊï∞ÊçÆ
const loading = computed(() => isLoading.value)
const groupLoading = ref(false)
const selectedGroupId = ref(null)
const selectedGroupName = ref('')
const groupSearchQuery = ref('')
const providerFilter = ref('')
const selectedHosts = ref([])

// ÊêúÁ¥¢ÂèÇÊï∞
const searchParams = reactive({
  keyword: '',
  status: '',
  region: '',
  group_id: null,
  page: 1,
  page_size: 20
})

// Ê†ëÂΩ¢ÁªÑ‰ª∂ÈÖçÁΩÆ
const treeProps = {
  children: 'children',
  label: 'name'
}

// ÁªàÁ´ØÁõ∏ÂÖ≥
const terminalVisible = ref(false)
const currentHost = ref(null)

// ‰∏ªÊú∫ÁªÑÁÆ°ÁêÜ
const groupDialogVisible = ref(false)
const groupFormData = ref({
  name: '',
  description: '',
  parent_id: null
})
const isEditingGroup = ref(false)
const editingGroupId = ref(null)

// ‰∏ªÊú∫Ê∑ªÂä†ÂäüËÉΩ
const addHostDialogVisible = ref(false)
const hostFormData = ref({
  name: '',
  public_ip: [],
  private_ip: [],
  status: 'running',
  os: '',
  region: '',
  provider_type: 'aws',
  group_id: null,
  configuration: {
    cpu_cores: 1,
    memory_size: 1,
    disk_size: 20,
    instance_type: 't2.micro'
  }
})

// Â∑•ÂÖ∑ÂáΩÊï∞
const getDisplayIP = (ips) => {
  if (!ips || !Array.isArray(ips)) return '-'
  return ips.join(', ')
}

const getStatusColor = (status) => {
  const statusMap = {
    'running': 'success',
    'stopped': 'danger',
    'pending': 'warning'
  }
  return statusMap[status] || 'info'
}

const getStatusText = (status) => {
  const statusMap = {
    'running': 'ËøêË°å‰∏≠',
    'stopped': 'Â∑≤ÂÅúÊ≠¢',
    'pending': 'ÂêØÂä®‰∏≠'
  }
  return statusMap[status] || status
}

// Ê†ºÂºèÂåñÈÖçÁΩÆ‰ø°ÊÅØ - Âè™ÊòæÁ§∫Ê†∏ÂøÉ‰ø°ÊÅØ
const formatConfiguration = (config) => {
  if (!config || typeof config !== 'object') return { cpu: '-', memory: '-', disk: '-' }

  try {
    const configObj = typeof config === 'string' ? JSON.parse(config) : config
    return {
      cpu: configObj.cpu_cores ? `${configObj.cpu_cores}Ê†∏` : '-',
      memory: configObj.memory_size ? `${configObj.memory_size}GB` : '-',
      disk: configObj.disk_size ? `${configObj.disk_size}GB` : '-'
    }
  } catch (error) {
    return { cpu: '-', memory: '-', disk: '-' }
  }
}

// Ëé∑Âèñ‰∫ëÂéÇÂïÜÊòæÁ§∫ÂêçÁß∞
const getProviderName = (provider) => {
  const providerMap = {
    'aws': 'AWS',
    'aliyun': 'ÈòøÈáå‰∫ë',
    'tencent': 'ËÖæËÆØ‰∫ë',
    'huawei': 'Âçé‰∏∫‰∫ë'
  }
  return providerMap[provider] || provider
}

// Ëé∑Âèñ‰∫ëÂéÇÂïÜÈ¢úËâ≤
const getProviderColor = (provider) => {
  const colorMap = {
    'aws': '#FF9900',
    'aliyun': '#FF6A00',
    'tencent': '#006EFF',
    'huawei': '#FF0000'
  }
  return colorMap[provider] || '#666666'
}

// ËÆ°ÁÆóÂ±ûÊÄß
const filteredGroupTree = computed(() => {
  try {
    const allGroupsNode = {
      id: null,
      name: 'ÂÖ®ÈÉ®‰∏ªÊú∫',
      host_count: hostList.value?.length || 0,
      children: []
    }

    // Á°Æ‰øùhostGroupTree.valueÊòØÊï∞ÁªÑÔºåÊ∑ªÂä†Êõ¥Âº∫ÁöÑ‰øùÊä§
    let groups = []
    if (hostGroupTree.value && Array.isArray(hostGroupTree.value)) {
      groups = hostGroupTree.value
    } else if (hostGroupTree.value && typeof hostGroupTree.value === 'object') {
      // Â¶ÇÊûúÊòØÂØπË±°ÔºåÂ∞ùËØïËé∑ÂèñdataÂ±ûÊÄß
      groups = hostGroupTree.value.data || []
    }

    let tree = [allGroupsNode, ...groups]

    if (groupSearchQuery.value) {
      const query = groupSearchQuery.value.toLowerCase()
      tree = tree.filter(group =>
        group.name && group.name.toLowerCase().includes(query)
      )
    }

    return tree
  } catch (error) {
    console.error('filteredGroupTreeËÆ°ÁÆóÈîôËØØ:', error)
    return [{
      id: null,
      name: 'ÂÖ®ÈÉ®‰∏ªÊú∫',
      host_count: 0,
      children: []
    }]
  }
})

const displayHostList = computed(() => {
  return hostList.value
})

// Êï∞ÊçÆÂ§ÑÁêÜÊñπÊ≥ïÂ∑≤Âú®‰∏äÈù¢ÂÆö‰πâ

const getConfigDisplay = (config) => {
  if (!config) return '-'
  if (typeof config === 'string') return config
  if (typeof config === 'object') {
    const cpu = config.cpu_cores || config.cpu || ''
    const memory = config.memory_size || config.memory || ''
    if (cpu && memory) {
      return `${cpu}Ê†∏${memory}GB`
    }
    return config.instance_type || '-'
  }
  return '-'
}

const getRegionDisplay = (region) => {
  const regionMap = {
    'cn-hangzhou': 'Âçé‰∏ú1',
    'cn-shanghai': 'Âçé‰∏ú2',
    'cn-qingdao': 'ÂçéÂåó1',
    'cn-beijing': 'ÂçéÂåó2',
    'cn-shenzhen': 'ÂçéÂçó1',
    'ap-southeast-1': 'Êñ∞Âä†Âù°',
    'us-east-1': 'Áæé‰∏ú1',
    'us-west-1': 'ÁæéË•ø1'
  }
  return regionMap[region] || region || '-'
}

// Áä∂ÊÄÅÊ†áÁ≠æÁ±ªÂûã
const getStatusTagType = (status) => {
  const statusMap = {
    'running': 'success',
    'stopped': 'danger',
    'maintenance': 'warning',
    'pending': 'info'
  }
  return statusMap[status] || 'info'
}

// Áä∂ÊÄÅÊòæÁ§∫ÊñáÊú¨
const getStatusDisplayText = (status) => {
  const statusMap = {
    'running': 'ËøêË°å‰∏≠',
    'stopped': 'Â∑≤ÂÅúÊ≠¢',
    'maintenance': 'Áª¥Êä§‰∏≠',
    'pending': 'ÂêØÂä®‰∏≠'
  }
  return statusMap[status] || 'Êú™Áü•'
}

// ‰∫ëÂéÇÂïÜÊ†áÁ≠æÁ±ªÂûã
const getProviderTagType = (provider) => {
  const providerMap = {
    'aliyun': 'warning',
    'tencent': 'primary',
    'huawei': 'success',
    'aws': 'info',
    'manual': ''
  }
  return providerMap[provider] || 'info'
}

// ‰∫ëÂéÇÂïÜÊòæÁ§∫ÊñáÊú¨
const getProviderDisplayText = (provider) => {
  const providerMap = {
    'aliyun': 'ÈòøÈáå‰∫ë',
    'tencent': 'ËÖæËÆØ‰∫ë',
    'huawei': 'Âçé‰∏∫‰∫ë',
    'aws': 'AWS',
    'manual': 'Ëá™Âª∫'
  }
  return providerMap[provider] || 'Êú™Áü•'
}

// ‰∫ã‰ª∂Â§ÑÁêÜÂáΩÊï∞
const handleGroupSelect = (data) => {
  selectedGroupId.value = data.id
  selectedGroupName.value = data.name
  searchParams.group_id = data.id
  searchParams.page = 1
  fetchHosts()
}

const handleSearch = () => {
  searchParams.page = 1
  fetchHosts()
}

const handleProviderFilter = () => {
  handleSearch()
}

const handleSelectionChange = (selection) => {
  selectedHosts.value = selection
}

const refreshGroups = async () => {
  groupLoading.value = true
  try {
    await hostStore.fetchHostGroupTree()
    // Êõ¥Êñ∞Êú¨Âú∞ÁöÑhostGroupTree
    hostGroupTree.value = hostStore.hostGroupTree || []
    ElMessage.success('ÂàÜÁªÑÊï∞ÊçÆÂà∑Êñ∞ÊàêÂäü')
  } catch (error) {
    ElMessage.error('ÂàÜÁªÑÊï∞ÊçÆÂà∑Êñ∞Â§±Ë¥•')
    hostGroupTree.value = []
  } finally {
    groupLoading.value = false
  }
}

const refreshData = async () => {
  try {
    await fetchHosts()
    ElMessage.success('Êï∞ÊçÆÂà∑Êñ∞ÊàêÂäü')
  } catch (error) {
    ElMessage.error('Êï∞ÊçÆÂà∑Êñ∞Â§±Ë¥•')
  }
}

const fetchHosts = async () => {
  try {
    await hostStore.fetchHosts(searchParams)
  } catch (error) {
    console.error('Ëé∑Âèñ‰∏ªÊú∫ÂàóË°®Â§±Ë¥•:', error)
  }
}

// ‰∏ªÊú∫ÁªÑÁÆ°ÁêÜ
const handleGroupRightClick = (event, node, data) => {
  event.preventDefault()
  showGroupContextMenu(event, data)
}

const showGroupContextMenu = (event, group) => {
  console.log('Âè≥ÈîÆÁÇπÂáª‰∏ªÊú∫ÁªÑ:', group)
}

const handleAddGroup = (parentGroup = null) => {
  groupFormData.value = {
    name: '',
    description: '',
    parent_id: parentGroup?.id || null
  }
  isEditingGroup.value = false
  editingGroupId.value = null
  groupDialogVisible.value = true
}

const handleEditGroup = (group) => {
  groupFormData.value = {
    name: group.name,
    description: group.description || '',
    parent_id: group.parent_id
  }
  isEditingGroup.value = true
  editingGroupId.value = group.id
  groupDialogVisible.value = true
}

const handleDeleteGroup = async (group) => {
  try {
    await ElMessageBox.confirm(
      `Á°ÆÂÆöË¶ÅÂà†Èô§‰∏ªÊú∫ÁªÑ "${group.name}" ÂêóÔºüÂà†Èô§ÂêéËØ•ÁªÑ‰∏ãÁöÑ‰∏ªÊú∫Â∞ÜÁßªÂä®Âà∞Ê†πÁõÆÂΩï„ÄÇ`,
      'Á°ÆËÆ§Âà†Èô§',
      {
        confirmButtonText: 'Á°ÆÂÆö',
        cancelButtonText: 'ÂèñÊ∂à',
        type: 'warning'
      }
    )
    await hostStore.deleteHostGroup(group.id)
    ElMessage.success(`Â∑≤Âà†Èô§‰∏ªÊú∫ÁªÑ: ${group.name}`)
  } catch (error) {
    if (error !== 'cancel') {
      ElMessage.error('Âà†Èô§Â§±Ë¥•')
    }
  }
}

const saveGroup = async () => {
  try {
    if (isEditingGroup.value) {
      await hostStore.updateHostGroup(editingGroupId.value, groupFormData.value)
      ElMessage.success('‰∏ªÊú∫ÁªÑÊõ¥Êñ∞ÊàêÂäü')
    } else {
      await hostStore.addHostGroup(groupFormData.value)
      ElMessage.success('‰∏ªÊú∫ÁªÑÂàõÂª∫ÊàêÂäü')
    }
    groupDialogVisible.value = false
  } catch (error) {
    ElMessage.error(isEditingGroup.value ? 'Êõ¥Êñ∞Â§±Ë¥•' : 'ÂàõÂª∫Â§±Ë¥•')
  }
}

// ‰∏ªÊú∫Êìç‰Ωú
const handleAdd = () => {
  // ÈáçÁΩÆË°®ÂçïÊï∞ÊçÆ
  hostFormData.value = {
    name: '',
    public_ip: [],
    private_ip: [],
    status: 'running',
    os: '',
    region: '',
    provider_type: 'aws',
    group_id: selectedGroupId.value,
    configuration: {
      cpu_cores: 1,
      memory_size: 1,
      disk_size: 20,
      instance_type: 't2.micro'
    }
  }
  addHostDialogVisible.value = true
}

const saveHost = async () => {
  try {
    // ËøôÈáåÂ∫îËØ•Ë∞ÉÁî®ÂêéÁ´ØAPI‰øùÂ≠ò‰∏ªÊú∫
    // await hostStore.addHost(hostFormData.value)
    ElMessage.success('‰∏ªÊú∫Ê∑ªÂä†ÊàêÂäü')
    addHostDialogVisible.value = false
    await fetchHosts()
  } catch (error) {
    ElMessage.error('‰∏ªÊú∫Ê∑ªÂä†Â§±Ë¥•')
  }
}

const handleView = (row) => {
  ElMessage.info(`Êü•Áúã‰∏ªÊú∫: ${row.name}`)
}

const handleEdit = (row) => {
  ElMessage.info(`ÁºñËæë‰∏ªÊú∫: ${row.name}`)
}

const handleTerminal = (row) => {
  currentHost.value = row
  terminalVisible.value = true
}

const handleDelete = async (row) => {
  try {
    await ElMessageBox.confirm(
      `Á°ÆÂÆöË¶ÅÂà†Èô§‰∏ªÊú∫ "${row.name}" ÂêóÔºü`,
      'Á°ÆËÆ§Âà†Èô§',
      {
        confirmButtonText: 'Á°ÆÂÆö',
        cancelButtonText: 'ÂèñÊ∂à',
        type: 'warning'
      }
    )
    await hostStore.deleteHost(row.id)
    ElMessage.success(`Â∑≤Âà†Èô§‰∏ªÊú∫: ${row.name}`)
    await fetchHosts()
  } catch (error) {
    if (error !== 'cancel') {
      ElMessage.error('Âà†Èô§Â§±Ë¥•')
    }
  }
}

const handleSizeChange = (val) => {
  searchParams.page_size = val
  searchParams.page = 1
  fetchHosts()
}

const handleCurrentChange = (val) => {
  searchParams.page = val
  fetchHosts()
}

// ÁîüÂëΩÂë®Êúü
onMounted(async () => {
  try {
    await hostStore.fetchHostGroupTree()
    // ‰ªéstore‰∏≠Ëé∑ÂèñÊï∞ÊçÆÂπ∂ËÆæÁΩÆÂà∞Êú¨Âú∞ref
    hostGroupTree.value = hostStore.hostGroupTree || []
  } catch (error) {
    console.error('Ëé∑Âèñ‰∏ªÊú∫ÁªÑÂ§±Ë¥•:', error)
    hostGroupTree.value = []
  }
  await fetchHosts()
})
</script>

<style scoped>
/* ‰∏ªÂÆπÂô®Ê†∑Âºè */
.host-management-pro {
  height: 100vh;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  padding: 16px;
}

.main-container {
  height: 100%;
  background: white;
  border-radius: 12px;
  overflow: hidden;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
  backdrop-filter: blur(10px);
}

/* Â∑¶‰æßËæπÊ†èÊ†∑Âºè */
.sidebar {
  background: linear-gradient(180deg, #f8f9fa 0%, #e9ecef 100%);
  border-right: 1px solid #dee2e6;
  box-shadow: 2px 0 16px rgba(0, 0, 0, 0.1);
}

.sidebar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 24px;
  border-bottom: 1px solid #dee2e6;
  background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
}

.sidebar-title {
  margin: 0;
  font-size: 18px;
  font-weight: 700;
  color: #2c3e50;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}

.refresh-btn {
  font-size: 12px;
  background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
  border: none;
  color: white;
  padding: 8px 16px;
  border-radius: 6px;
  font-weight: 500;
  transition: all 0.3s ease;
  box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
}

.refresh-btn:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
}

.group-search {
  padding: 16px 20px;
  border-bottom: 1px solid #f0f0f0;
}

.group-tree-container {
  padding: 8px 0;
  max-height: calc(100vh - 140px);
  overflow-y: auto;
}

.group-tree {
  padding: 0 12px;
}

.tree-node {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
  padding-right: 8px;
  position: relative;
}

.tree-node:hover .node-actions {
  opacity: 1;
}

.node-label {
  font-size: 14px;
  color: #262626;
  flex: 1;
}

.node-count {
  font-size: 12px;
  color: #8c8c8c;
  margin-right: 8px;
}

.node-actions {
  display: flex;
  gap: 2px;
  opacity: 0;
  transition: opacity 0.2s;
}

.node-actions .el-button {
  padding: 2px 4px;
  font-size: 12px;
  min-height: auto;
  border: none;
}

.node-actions .el-button:hover {
  background-color: #f0f0f0;
}

/* Âè≥‰æß‰∏ªÂÜÖÂÆπÂå∫Ê†∑Âºè */
.main-content {
  padding: 0;
  background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
}

.content-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  padding: 24px 24px 16px;
  background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
  border-bottom: 1px solid #e8e8e8;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.header-left {
  flex: 1;
}

.page-title {
  margin: 0 0 8px 0;
  font-size: 28px;
  font-weight: 700;
  color: #2c3e50;
  text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.breadcrumb {
  display: flex;
  align-items: center;
  font-size: 14px;
  color: #8c8c8c;
}

.breadcrumb-item {
  color: #8c8c8c;
}

.breadcrumb-separator {
  margin: 0 8px;
  color: #d9d9d9;
}

.breadcrumb-current {
  color: #1890ff;
}

.header-actions {
  display: flex;
  gap: 12px;
}

/* Â∑•ÂÖ∑Ê†èÊ†∑Âºè */
.toolbar {
  padding: 16px 24px;
  background: white;
  border-bottom: 1px solid #e8e8e8;
}

.search-input,
.filter-select {
  width: 100%;
}

/* Ë°®Ê†ºÂÆπÂô®Ê†∑Âºè */
.table-container {
  margin: 16px 24px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 24px rgba(0, 0, 0, 0.1);
  overflow: hidden;
  border: 1px solid #e9ecef;
  animation: fadeInUp 0.6s ease-out;
}

.host-table {
  border-radius: 8px;
}

/* Ë°®Ê†ºÂçïÂÖÉÊ†ºÊ†∑Âºè */
.host-name-cell {
  display: flex;
  align-items: center;
}

.host-name {
  font-weight: 500;
  color: #262626;
}

.ip-cell {
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
  font-size: 12px;
}

.ip-item {
  margin-bottom: 2px;
}

.ip-item:last-child {
  margin-bottom: 0;
}

.ip-label {
  color: #8c8c8c;
  margin-right: 4px;
}

.ip-value {
  color: #262626;
}

.config-cell {
  font-size: 13px;
}

.config-text {
  color: #595959;
}

.os-text,
.region-text {
  color: #595959;
  font-size: 13px;
}

.action-buttons {
  display: flex;
  gap: 8px;
  justify-content: center;
}

/* ÂàÜÈ°µÊ†∑Âºè */
.pagination-wrapper {
  display: flex;
  justify-content: center;
  padding: 16px 24px 24px;
}

/* Ë°®Ê†ºË°åÊÇ¨ÊµÆÊïàÊûú */
.host-table :deep(.el-table__row):hover {
  background-color: #fafafa !important;
}

/* Á°Æ‰øùÊ≤°Êúâ‰ªª‰ΩïÂ≠ó‰ΩìÂõæÊ†áÁõ∏ÂÖ≥ÁöÑÊ†∑Âºè */
.host-table :deep(.el-table__row) *,
.group-tree :deep(.el-tree-node) *,
.sidebar *,
.main-content * {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
}

/* Âº∫ÂäõÁ¶ÅÁî®ÊâÄÊúâÂèØËÉΩÁöÑ‰º™ÂÖÉÁ¥†ÂÜÖÂÆπ */
.host-table :deep(.el-table__row) *::before,
.host-table :deep(.el-table__row) *::after,
.group-tree :deep(.el-tree-node) *::before,
.group-tree :deep(.el-tree-node) *::after,
.sidebar *::before,
.sidebar *::after,
.main-content *::before,
.main-content *::after {
  content: none !important;
  display: none !important;
}

/* Á¶ÅÁî®ÊâÄÊúâÂèØËÉΩÁöÑÂõæÊ†áÂ≠ó‰Ωì */
.host-management-pro * {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif !important;
}

/* ÂìçÂ∫îÂºèËÆæËÆ° */
@media (max-width: 1200px) {
  .sidebar {
    width: 240px !important;
  }
}

@media (max-width: 768px) {
  .sidebar {
    width: 200px !important;
  }

  .content-header {
    flex-direction: column;
    gap: 16px;
    align-items: stretch;
  }

  .header-actions {
    justify-content: flex-start;
  }

  .toolbar .el-row {
    flex-direction: column;
    gap: 12px;
  }

  .toolbar .el-col {
    width: 100% !important;
  }
}

/* Âä®ÁîªÊïàÊûú */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes slideInLeft {
  from {
    opacity: 0;
    transform: translateX(-20px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.tree-node {
  animation: slideInLeft 0.4s ease-out;
}

/* Ë°®Ê†ºË°åÊÇ¨ÊµÆÊïàÊûúÂ¢ûÂº∫ */
.host-table :deep(.el-table__row) {
  transition: all 0.3s ease;
}

.host-table :deep(.el-table__row):hover {
  background: linear-gradient(135deg, #f8f9fa 0%, #e3f2fd 100%) !important;
  transform: scale(1.01);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

/* Ë°®Ê†ºÂ§¥ÈÉ®ÁæéÂåñ */
.host-table :deep(.el-table__header) {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
}

.host-table :deep(.el-table__header th) {
  background: transparent !important;
  color: #2c3e50 !important;
  font-weight: 700 !important;
  border-bottom: 2px solid #dee2e6 !important;
  font-size: 14px !important;
}

/* ÊåâÈíÆÁæéÂåñ */
.action-buttons .el-button {
  transition: all 0.3s ease;
  border-radius: 6px;
  font-weight: 500;
}

.action-buttons .el-button:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
}

/* Ê†áÁ≠æÁæéÂåñ */
.el-tag {
  border-radius: 6px !important;
  font-weight: 500 !important;
  border: none !important;
}

/* ÊªöÂä®Êù°ÁæéÂåñ */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 4px;
}

::-webkit-scrollbar-thumb {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
}

/* ËæìÂÖ•Ê°ÜÂíåÈÄâÊã©Âô®ÁæéÂåñ */
.el-input__wrapper,
.el-select__wrapper {
  border-radius: 8px !important;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
  transition: all 0.3s ease !important;
}

.el-input__wrapper:hover,
.el-select__wrapper:hover {
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
}

.el-input__wrapper.is-focus,
.el-select__wrapper.is-focus {
  box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2) !important;
}
</style>
